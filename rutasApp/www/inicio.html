<!DOCTYPE html>
<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Mapa con Geolocalización</title>
    <script src="cordova.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6NJxMsGQckYOVfhJXufWTxKt0oHXC1Zg"></script>
    <style>
       body {
      background-color: #f8f9fa;
    }
    .navbar {
      margin-bottom: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
    #map {
      height: 500px;
      width: 100%;
      margin-bottom: 20px;
    }
    .sidebar {
      height: 100vh;
      width: 250px;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      padding-top: 20px;
    }
    .sidebar a {
      color: white;
      padding: 10px;
      text-decoration: none;
      display: block;
    }
    .sidebar a:hover {
      background-color: #007bff;
    }

    </style>
    
    <!-- CSS de Bootstrap -->
<!--<link href="css/bootstrap.min.css" rel="stylesheet">-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" 
integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
<!-- Scripts de Bootstrap (jQuery requerido) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!--<script src="/js/popper.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>


<script type="text/javascript">    
    $(document).ready(function(){
    $("#EnviarDatos").click(function() {
        document.getElementById("enviando").innerHTML =`<div class="spinner-border text-primary" role="status">                                                            
                                                            </div>
                                                            <span class="visually-hidden">Enviando...</span>`;  
    var db = window.sqlitePlugin.openDatabase({ name: 'routes.db', location: 'default' });
        db.transaction(function(tx) {
            tx.executeSql('SELECT * FROM routes', [], function(tx, result) {
                let routes = [];
                if (result.rows.length > 0) {
                    for (let i = 0; i < result.rows.length; i++) {
                        let route = result.rows.item(i); // Obtén el objeto de la fila actual
                        console.log('Raw route data:', route);
                        try {
                            // Parsea las propiedades si son cadenas JSON
                            if (typeof route.origin === 'string') {
                                route.origin = JSON.parse(route.origin);
                            }
                        } catch (e) {
                            console.error('Error parsing origin:', route.origin);
                            continue; // Skip this route if parsing fails
                        }
                        try {
                            if (typeof route.destination === 'string' && route.destination.trim() !== '') {
                                // Verifica si la cadena `destination` es JSON válido y no está vacía
                                try {
                                    // Intenta parsear el JSON
                                    let destinationObj = JSON.parse(route.destination);                                    
                                    // Verifica si el objeto `destinationObj` tiene las propiedades `lat` y `lng`
                                    if (destinationObj.lat !== undefined && destinationObj.lng !== undefined) {
                                        route.destination = {
                                            lat: destinationObj.lat,
                                            lng: destinationObj.lng
                                        };
                                    } else {
                                        console.error('Error: Invalid format for destination:', route.destination);
                                        continue; // O maneja el error según sea necesario
                                    }
                                } catch (e) {
                                    console.error('Error parsing destination JSON:', route.destination, e);
                                    continue; // O maneja el error según sea necesario
                                }
                            } else {
                                // Maneja el caso en el que `destination` es una cadena vacía
                                console.warn('Warning: Destination is empty or not a valid string:', route.destination);
                                route.destination = {
                                    lat: null,
                                    lng: null
                                };
                            }
                        }catch (e) {
                            console.error('Error parsing destination:', route.destination);
                            continue; // Skip this route if parsing fails
                        }
                        routes.push(route);
                    }                          
                    fetch('http://4.228.229.204/rutas/saveRoutes.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(routes)
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("success").innerHTML = `
                        <div id="succes" class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>Exito!!!</strong> Datos enviados !!!!
                            <!--<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
                        </div>
                        `;
                        document.getElementById("enviando").hidden = true;
                        setTimeout(function() {
                            window.location.reload(true);
                            db.transaction(function(tx){
                                tx.executeSql("DELETE FROM routes",[],function(tx, result){
                                    document.getElementById("enviando").hidden = true;
                                });
                            })

                        }, 3000);
                        //alert('Éxito: ' + JSON.stringify(data));


                    })
                    .catch(error => {
                        console.error('Error en la petición Fetch:', error);
                        alert('Error: No se pudo enviar los datos.');
                    });
            } else {
                alert("No hay rutas para enviar.");
            }
        }, function(tx, error) {
            console.error('Error al ejecutar SQL:', error.message);
        });
    });
    });
})
   </script>
   <script>

    function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                userId: params.get('userId'),
                userName: params.get('userName'),
                userEmail: params.get('userEmail'),
                userNombres: params.get('userNombres'),
                userPaterno: params.get('userPaterno'),
                userMaterno: params.get('userMaterno'),
                userTelefono: params.get('userTelefono'),
                userDireccion: params.get('userDireccion'),
                datosRutas: JSON.parse(params.get('datosRutas')) // Convertir de cadena JSON a objeto
            };
        }

        // Función para mostrar los datos en la página
        function mostrarDatos() {
            const queryParams = getQueryParams();

            // Mostrar datos del usuario
            document.getElementById('userId').textContent = queryParams.userId;
            document.getElementById('userName').textContent = queryParams.userName;
            document.getElementById('userEmail').textContent = queryParams.userEmail;
            document.getElementById('userNombres').textContent = queryParams.userNombres;
            document.getElementById('userPaterno').textContent = queryParams.userPaterno;
            document.getElementById('userMaterno').textContent = queryParams.userMaterno;
            document.getElementById('userTelefono').textContent = queryParams.userTelefono;
            document.getElementById('userDireccion').textContent = queryParams.userDireccion;
            document.getElementById('user-info').innerText = `Bienvenido, ${queryParams.userNombres}`;
            document.getElementById('userId').value = queryParams.userId;
            // Mostrar datos de rutas
           
            const rutasContainer = document.getElementById('rutas');
            if (queryParams.datosRutas && queryParams.datosRutas.length > 0) {
                //alert(JSON.stringify(queryParams.datosRutas));
                queryParams.datosRutas.forEach(ruta => {
                    const rutaCard = document.createElement('div');
                    rutaCard.className = 'card mb-3';
                    rutaCard.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">Id ruta: ${ruta.id_ruta}</h5>
                            <p class="card-text">ID usuario: ${ruta.user_id}</p>
                            <p class="card-text"><strong>Distancia:</strong> ${ruta.distance || 'No disponible'}</p>
                            <p class="card-text"><strong>Combustible Consumido:</strong> ${ruta.fuelConsumption || 'No disponible'}</p>
                            <p class="card-text"><strong>Direccion Origen:</strong> ${ruta.direccion_origen || 'No disponible'}</p>
                            <p class="card-text"><strong>Direccion Destino:</strong> ${ruta.direccion_destino || 'No disponible'}</p>
                        </div>
                    `;
                    rutasContainer.appendChild(rutaCard);
                });
            } else {
                rutasContainer.innerHTML = '<p class="text-muted">No se encontraron rutas para este usuario.</p>';
            }
        }
        document.addEventListener('DOMContentLoaded', mostrarDatos);
</script>
   
</head>
<body>  
        <!--<h1>Mapa con Agregar Destino desde Dirección</h1>-->
            
            <!-- Navbar -->
                <div class="container mt-4">
                    <h1 id="user-info">Welcome</h1>
                    <input type="hidden" id="userId" />
                    <!-- Navbar -->
                    <nav class="navbar navbar-expand-lg navbar-light bg-light">
                        <div class="container-fluid">
                            <span class="navbar-brand mb-0 h1">Aplicación de Destinos</span>
                        </div>
                    </nav>
                    <!--<div class="sidebar">
                        <h4 class="text-white text-center">Mi Menú</h4>
                        <a href="#">formulario</a>
                        <a href="#">Conductores</a>
                        <a href="#">Rutas</a>
                        <a href="#">Ajustes</a>
                      </div>-->
                    <!-- Pestañas -->
                    <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#formulario" role="tab" aria-controls="formulario" aria-selected="true">Agregar Destino</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="profile-tab" data-toggle="tab" href="#datosRuta" role="tab" aria-controls="datosRuta" aria-selected="false">Datos Ruta</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <!-- Formulario de dirección -->
                        <div class="tab-pane fade show active" id="formulario" role="tabpanel" aria-labelledby="home-tab">
                            <div class="card mt-3">
                                <div class="card-body">
                                    <form id="addressForm">
                                        <div class="form-group">
                                            <label for="addressInput">Ingresa una dirección de destino:</label>
                                            <input type="text" id="addressInput" name="addressInput" class="form-control" placeholder="ej: calle 123, comuna">
                                        </div>
                                        <div>
                                            <label for="rendimiento">Ingresa Rendimiento del vehiculo:</label>
                                            <select id="rendimiento" class="form-control" aria-label="Default select example">
                                                <option selected>Seleccione...</option>
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                              </select>
                                        </div>
                                        <button class="btn btn-primary btn-block" type="submit" id="buscar">Buscar</button>
                                    </form>

                                </div>
                            </div>
                            <!-- Mapa -->
                            <div id="map" class="mt-3"></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="address">Origen:</label>
                                    <input type="text" class="form-control" id="address" readonly />
                                </div>
                                <div class="form-group" id="ddestino" style="display:none">
                                    <label for="destino">Destino:</label>
                                    <input type="text" class="form-control" id="destino" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="distanciaDestino">Distancia a destino:</label>
                                    <input type="text" class="form-control" id="distanciaDestino" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="combustibleAConsumir">Combustible a consumir:</label>
                                    <input type="text" class="form-control" id="combustibleAConsumir" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="rendimientoLitro">Rendimiento del Vehículo:</label>
                                    <input type="text" class="form-control" id="rendimientoLitro" readonly />
                                </div>
                                <button class="btn btn-primary btn-block" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal" style="display:block" id="EnviarDatos">Enviar datos</button>
                            </div>
                        </div>
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <!--<h1 class="modal-title fs-5" id="exampleModalLabel">Envio De Datos</h1>-->
                                  <!--<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
                                </div>
                                <div class="modal-body">
                                    <div id="enviando" align="center"></div>
                                    <div id="success"></div>
                                </div>
                                <div class="modal-footer">
                                  <!--<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button type="button" class="btn btn-primary">Save changes</button>-->
                                </div>
                              </div>
                            </div>
                          </div>                      
                        <!-- Datos de la ruta -->
                        <div class="tab-pane fade" id="datosRuta" role="tabpanel" aria-labelledby="profile-tab">
                            <div class="card mt-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h1 class="card-title">Bienvenido</h1>
                                        <h2 class="card-subtitle mb-3">Datos del Usuario</h2>
                                        <p><strong>ID:</strong> <span id="userId"></span></p>
                                        <p><strong>Nombre:</strong> <span id="userName"></span></p>
                                        <p><strong>Email:</strong> <span id="userEmail"></span></p>
                                        <p><strong>Nombres:</strong> <span id="userNombres"></span></p>
                                        <p><strong>Apellido Paterno:</strong> <span id="userPaterno"></span></p>
                                        <p><strong>Apellido Materno:</strong> <span id="userMaterno"></span></p>
                                        <p><strong>Teléfono:</strong> <span id="userTelefono"></span></p>
                                        <p><strong>Dirección:</strong> <span id="userDireccion"></span></p>
                                    </div>
                                </div>
                                    <div id="rutas"></div>
                            </div>
                        </div>
                    </div>
                </div>
              
                
                
                <!-- Bootstrap JS and dependencies -->
                <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
                <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
            </body>
            </html>
            
   
    
<script>
document.addEventListener('deviceready', function() {
    var db = window.sqlitePlugin.openDatabase({ name: 'routes.db', location: 'default' });

    db.transaction(function(tx) {
        tx.executeSql(`
            CREATE TABLE IF NOT EXISTS routes (
                id INTEGER PRIMARY KEY AUTOINCREMENT, 
                origin TEXT, 
                destination TEXT, 
                distance TEXT, 
                fuelConsumption TEXT,
                user_id VARCHAR(255),
                estado VARCHAR(255),
                direccion_origen VARCHAR(255),
                direccion_destino VARCHAR(255),
                fecha DATETIME,
                rendimiento INTEGER
            )
        `, [], function(tx, result) {
            console.log("Table created successfully.");
        }, function(tx, error) {
            console.error("Error creating table:", error.message);
        });
    });
    navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 15
            });

            var userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Mi Ubicación'
            });
            
            // Inicializar geocodificador
            geocoder = new google.maps.Geocoder();
            //obtener direccion de ubicacion usuario
            geocodeLatLng(userLocation);
            function geocodeLatLng(latlng) {
                geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                    //document.getElementById("address").innerText = results[0].formatted_address;
                    $("#address").val(results[0].formatted_address);
                    } else {
                    window.alert("No results found");
                    }
                } else {
                    window.alert("Geocoder failed due to: " + status);
                }
                });
            }
            // Evento para añadir un marcador cuando el usuario haga clic en el mapa
            google.maps.event.addListener(map, 'click', function(event) {
                geocodeLatLng(event.latLng);
            });

            // Escuchar el envío del formulario para buscar la dirección
            document.getElementById('addressForm').addEventListener('submit', function(event) {
                event.preventDefault();
                geocodeAddress();
            });
            }, function() {
            alert('Error: No se pudo obtener la ubicación del dispositivo.');
        });
        function geocodeAddress() {
            var address = document.getElementById('addressInput').value;
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    var destination = results[0].geometry.location;
                    calculateRoute(userLocation, destination);
                } else {
                    alert('No se pudo geocodificar la dirección ingresada debido a: ' + status);
                }
            });
        }
    function calculateRoute(start, end) {
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();

        directionsRenderer.setMap(map);

        var request = {
            origin: start,
            destination: end,
            travelMode: 'DRIVING' // Puedes cambiar el modo de transporte aquí
        };

        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsRenderer.setDirections(result);

                // Calcular la distancia entre las dos ubicaciones
                var route = result.routes[0];
                var distance = 0;

                for (var i = 0; i < route.legs.length; i++) {
                    distance += route.legs[i].distance.value;
                } 
                let fechaActual = new Date();
                let fechaString = fechaActual.toISOString();
                var rendimientoLitro=$("#rendimiento").val();
                var distancia=(distance / 1000);
                var combustibleAconsumir=(distancia/rendimientoLitro);
                $("#distanciaDestino").val(distance / 1000).attr('disabled','true');
                $("#combustibleAConsumir").val(combustibleAconsumir.toFixed(2)).attr('disabled','true');
                var addressInput=$("#addressInput").val();
                var destino = $("#destino").val();
                var dirOrigen=$("#address").val();
                $("#rendimientoLitro").val(rendimientoLitro);
                $("#EnviarDatos").show();
                var userId = $("#userId").val()
                //alert('La distancia entre las ubicaciones es de aproximadamente ' + (distance / 1000) + ' km.');
                const routeData = {
                    origin: start,
                    destination: end,
                    distance: distancia,
                    fuelConsumption: combustibleAconsumir.toFixed(2) + " litros",
                    userId,
                    estado:"cerrado",
                    direccionOrigen:dirOrigen,
                    direccionDestino:addressInput,
                    fecha:fechaString,
                    rendimiento:rendimientoLitro

                };
                var db = window.sqlitePlugin.openDatabase({name: 'routes.db', location: 'default'});
                //alert(routeData)
                console.log(routeData)
                saveRouteToDB(routeData);
                //saveRoute(origin, destination, distance, fuelConsumption.toFixed(2) + " litros");
                function saveRouteToDB(routeData) {
                   db.transaction(function(tx) {
                        tx.executeSql(
                            'INSERT INTO routes (origin, destination, distance, fuelConsumption, user_id, estado, direccion_origen, direccion_destino, fecha, rendimiento) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)', 
                            [
                                JSON.stringify(routeData.origin), 
                                JSON.stringify(routeData.destination), 
                                routeData.distance, 
                                routeData.fuelConsumption, 
                                routeData.userId, 
                                routeData.estado,
                                routeData.direccionOrigen,
                                routeData.direccionDestino,
                                routeData.fecha,
                                routeData.rendimiento
                            ], 
                            function(tx, result) {
                                console.log('Data inserted successfully.');
                            }, 
                            function(tx, error) {
                                console.error('Error inserting data:', error.message);
                            }
                        );
                    });
                }
            } else {
                alert('No se pudo calcular la ruta debido a: ' + status);
            }
        });
    }
    
    
    
})
    </script>
        <!--<script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6NJxMsGQckYOVfhJXufWTxKt0oHXC1Zg&callback=initMap">
        </script>-->
    </body>
 </html>
